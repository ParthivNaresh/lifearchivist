name: SonarCloud Analysis

on:
  workflow_run:
    workflows: ["Unit Tests"]
    types:
      - completed
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  sonarcloud:
    name: "SonarCloud Analysis"
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
        fetch-depth: 0

    - name: Download unit test coverage
      uses: actions/download-artifact@v4
      with:
        name: unit-tests-coverage
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        path: ./

    - name: List coverage files
      run: |
        echo "Available coverage files:"
        find . -name "*.xml" -o -name "htmlcov*" | sort
        echo "File sizes:"
        du -h *.xml 2>/dev/null || echo "No XML files found"

    - name: SonarCloud Scan
      uses: SonarSource/sonarqube-scan-action@v5.3.1
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
